<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅãÂëΩ„ÅÆ„ÉÄ„Ç§„Çπ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5em;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .header h1:hover {
            opacity: 0.8;
        }

        .login-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 20px 0;
            min-height: calc(100vh - 60px);
        }

        /* „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏ */
        .login-page {
            text-align: center;
            padding: 40px 20px;
        }

        .login-page h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .login-page input {
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .login-page button {
            padding: 15px 30px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s;
        }

        .login-page button:hover {
            transform: scale(1.05);
        }

        .login-page .cancel-btn {
            background: #6c757d;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ */
        .tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 0 20px;
        }

        @media (min-width: 768px) {
            .tabs-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
                padding: 0 40px;
            }
        }

        .tab-button {
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        @media (min-width: 768px) {
            .tab-button {
                padding: 50px 20px;
                font-size: 1.5em;
            }
        }

        /* Âõ∫ÂÆö„Çµ„Ç§„Ç≥„É≠„Éê„Éº */
        .dice-bar {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 100;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .dice-labels-bar {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }

        @media (min-width: 768px) {
            .dice-labels-bar {
                font-size: 1.5em;
            }
        }

        .roll-button-bar {
            padding: 8px 12px;
            font-size: 1.3em;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .roll-button-bar:hover:not(:disabled) {
            transform: scale(1.1);
        }

        .roll-button-bar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .rolling-animation {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content-box {
            padding: 30px 20px;
            background: #f8f9fa;
            font-size: 1em;
            line-height: 1.8;
            color: #333;
            min-height: 200px;
            white-space: pre-wrap;
        }

        @media (min-width: 768px) {
            .tab-content-box {
                padding: 40px;
                font-size: 1.1em;
            }
        }

        /* „Éõ„Çπ„Éà„Ç≥„É≥„Éà„É≠„Éº„É´ */
        .host-controls {
            margin: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }

        @media (min-width: 768px) {
            .host-controls {
                margin: 30px 40px;
                padding: 25px;
            }
        }

        .host-controls h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .host-controls label {
            display: block;
            margin: 15px 0 5px 0;
            color: #856404;
            font-weight: bold;
            font-size: 0.95em;
        }

        .host-controls input, .host-controls textarea, .host-controls select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .host-controls textarea {
            min-height: 120px;
            resize: vertical;
        }

        .host-controls button {
            padding: 10px 20px;
            background: #ffc107;
            color: #856404;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px 5px 0 0;
        }

        .host-controls button:hover {
            background: #e0a800;
        }

        .host-controls .danger-btn {
            background: #dc3545;
            color: white;
        }

        .host-controls .danger-btn:hover {
            background: #c82333;
        }

        .host-controls .save-btn {
            background: #28a745;
            color: white;
        }

        .host-controls .save-btn:hover {
            background: #218838;
        }

        .dice-log {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }

        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .list-group {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .list-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .list-group-title {
            font-weight: bold;
            color: #856404;
            font-size: 1.1em;
        }

        .list-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .list-item {
            padding: 5px 10px;
            background: #f8f9fa;
            border: 2px solid #ffc107;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        .list-item button {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.8em;
            margin: 0;
        }

        /* ÁîªÂÉèÊäïÁ®ø */
        .image-upload-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            border: 2px solid #667eea;
        }

        .image-upload-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .image-upload-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .image-upload-form input[type="file"] {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
        }

        .image-upload-form select {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
        }

        .image-upload-form button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }

        .image-upload-form button:hover {
            background: #5568d3;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .image-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .image-card.locked {
            border-color: #dc3545;
        }

        .image-card.unlocked {
            border-color: #28a745;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            filter: blur(20px);
        }

        .image-preview.unlocked {
            filter: none;
        }

        .image-card-info {
            padding: 15px;
        }

        .image-timer {
            font-size: 1.2em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 10px;
        }

        .image-timer.unlocked {
            color: #28a745;
        }

        .host-image-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .host-image-controls button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .host-image-controls .view-btn {
            background: #667eea;
            color: white;
        }

        .host-image-controls .delete-btn {
            background: #dc3545;
            color: white;
        }

        .host-image-controls .edit-btn {
            background: #ffc107;
            color: #856404;
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 onclick="goHome()">ÈÅãÂëΩ„ÅÆ„ÉÄ„Ç§„Çπ</h1>
            <button class="login-btn" onclick="showLoginPage()">üîë</button>
        </div>

        <div class="content">
            <!-- „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏ -->
            <div id="loginPage" class="login-page hidden">
                <h2>„Éõ„Çπ„Éà„É≠„Ç∞„Ç§„É≥</h2>
                <input type="password" id="hostIdInput" placeholder="„Éõ„Çπ„ÉàID">
                <br>
                <button onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
                <button class="cancel-btn" onclick="cancelLogin()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>

            <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
            <div id="homePage">
                <div class="tabs-grid" id="tabsGrid">
                    <!-- „Çø„Éñ„Éú„Çø„É≥„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>

                <!-- „Éõ„Çπ„ÉàË®≠ÂÆö - „Éõ„Éº„É† -->
                <div id="hostHomeControls" class="host-controls hidden">
                    <h3>üîß „Éõ„Éº„É†Ë®≠ÂÆö</h3>
                    <button onclick="addNewTab()">‚ûï Êñ∞„Åó„ÅÑ„Çø„Éñ„ÇíËøΩÂä†</button>
                </div>
            </div>

            <!-- „Çø„Éñ„Éö„Éº„Ç∏ -->
            <div id="tabPage" class="hidden">
                <div class="dice-bar" id="diceBarContainer">
                    <div class="dice-labels-bar" id="diceLabels"></div>
                    <button class="roll-button-bar" id="rollButton" onclick="rollAllDice()">üé≤</button>
                </div>

                <div class="tab-content-box" id="tabContentText"></div>

                <!-- ÁîªÂÉèÊäïÁ®ø„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <div id="imageSection" class="hidden">
                    <div class="image-upload-section">
                        <h3>üì∏ ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h3>
                        <div class="image-upload-form">
                            <input type="file" id="imageFileInput" accept="image/*">
                            <label>„É≠„ÉÉ„ÇØÊôÇÈñì„ÇíË®≠ÂÆö:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="font-size: 0.9em; color: #666;">Êó•</label>
                                    <input type="number" id="lockDays" value="0" min="0" max="365" 
                                           style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="font-size: 0.9em; color: #666;">ÊôÇÈñì</label>
                                    <input type="number" id="lockHours" value="0" min="0" max="23" 
                                           style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                                </div>
                                <div style="flex: 1; min-width: 100px;">
                                    <label style="font-size: 0.9em; color: #666;">ÂàÜ</label>
                                    <input type="number" id="lockMinutes" value="10" min="0" max="59" 
                                           style="width: 100%; padding: 8px; border: 2px solid #667eea; border-radius: 5px;">
                                </div>
                            </div>
                            <button onclick="uploadImage()">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
                        </div>
                    </div>
                    <div class="image-gallery" id="imageGallery"></div>
                </div>

                <!-- ÁîªÂÉè„É¢„Éº„ÉÄ„É´ -->
                <div id="imageModal" class="image-modal">
                    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
                    <img id="imageModalImg" class="image-modal-content">
                </div>

                <!-- „Éõ„Çπ„ÉàË®≠ÂÆö - „Çø„Éñ -->
                <div id="hostTabControls" class="host-controls hidden">
                    <h3>üîß „Çø„ÉñË®≠ÂÆö</h3>
                    
                    <label>„Çø„Éñ„Çø„Ç§„Éà„É´:</label>
                    <input type="text" id="editTabTitle">
                    
                    <label>„Çø„ÉñÂÜÖÂÆπ:</label>
                    <textarea id="editTabContent" placeholder="„Çø„Éñ„ÅÆË™¨Êòé„ÇÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ..."></textarea>
                    
                    <label>„Çø„Éñ„ÅÆÁ®ÆÈ°û:</label>
                    <select id="editTabType" onchange="toggleTabTypeSettings()">
                        <option value="dice">„Çµ„Ç§„Ç≥„É≠</option>
                        <option value="list">„É™„Çπ„ÉàÊäΩÈÅ∏</option>
                        <option value="image">ÁîªÂÉèÊäïÁ®ø</option>
                    </select>
                    
                    <!-- „Çµ„Ç§„Ç≥„É≠Ë®≠ÂÆö -->
                    <div id="diceSettings">
                        <label>„Çµ„Ç§„Ç≥„É≠„ÅÆÊï∞:</label>
                        <input type="number" id="editDiceCount" value="2" min="1" max="10">
                        
                        <label>„Çµ„Ç§„Ç≥„É≠„ÅÆÁØÑÂõ≤ÔºàÊúÄÂ∞èÔºâ:</label>
                        <input type="number" id="editDiceMin" value="1" min="0">
                        
                        <label>„Çµ„Ç§„Ç≥„É≠„ÅÆÁØÑÂõ≤ÔºàÊúÄÂ§ßÔºâ:</label>
                        <input type="number" id="editDiceMax" value="6" min="1">
                        
                        <label>„Çµ„Ç§„Ç≥„É≠„ÅÆ„É©„Éô„É´Ôºà„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÄÅ‰æã: w,x,y,zÔºâ:</label>
                        <input type="text" id="editDiceLabels" value="w,x">
                    </div>
                    
                    <!-- „É™„Çπ„ÉàË®≠ÂÆö -->
                    <div id="listSettings" class="hidden">
                        <button onclick="addListGroup()">‚ûï Êñ∞„Åó„ÅÑ„É™„Çπ„ÉàÈ†ÖÁõÆ„ÇíËøΩÂä†</button>
                        <div id="listGroupsContainer"></div>
                    </div>

                    <!-- ÁîªÂÉèÊäïÁ®øË®≠ÂÆö -->
                    <div id="imageSettings" class="hidden">
                        <p style="color: #856404; margin-bottom: 10px;">„É¶„Éº„Ç∂„Éº„ÅØÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„ÄÅ„É≠„ÉÉ„ÇØÊôÇÈñì„ÇíË®≠ÂÆö„Åß„Åç„Åæ„Åô„ÄÇ</p>
                    </div>
                    
                    <button onclick="applyTabSettings()">Ë®≠ÂÆö„ÇíÈÅ©Áî®</button>
                    <button class="danger-btn" onclick="deleteTab()">üóëÔ∏è „Åì„ÅÆ„Çø„Éñ„ÇíÂâäÈô§</button>
                    
                    <h3 style="margin-top: 30px;">üìä „É≠„Éº„É´Ë®òÈå≤</h3>
                    <div class="dice-log" id="diceLog"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // FirebaseË®≠ÂÆöÔºàËá™ÂàÜ„ÅÆË®≠ÂÆö„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºâ
        const firebaseConfig = {
           apiKey: "AIzaSyC9NmTiZsDiU4V-Zz0irfAL7xN55Jj9Z9o",
           authDomain: "dice-c9dc2.firebaseapp.com",
           databaseURL: "https://dice-c9dc2-default-rtdb.firebaseio.com",
           projectId: "dice-c9dc2",
           storageBucket: "dice-c9dc2.firebasestorage.app",
           messagingSenderId: "1027278685434",
           appId: "1:1027278685434:web:2d266ea2784910942b3543",
           measurementId: "G-L9TDVYHQ3P"
       };

        // FirebaseÂàùÊúüÂåñ
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let isHost = false;
        let currentTabId = null;
        let tabs = [];
        let lastRollTime = 0;
        const ROLL_COOLDOWN = 2000; // 2Áßí„ÅÆ„ÇØ„Éº„É´„ÉÄ„Ç¶„É≥

        // Firebase„Åã„Çâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        database.ref('tabs').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                tabs = Object.values(data);
            } else {
                // ÂàùÊúü„Éá„Éº„Çø„ÅØÁ©∫
                tabs = [];
            }
            renderTabs();
            
            // ÁèæÂú®„ÅÆ„Çø„Éñ„ÅåÈñã„Åã„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
            if (currentTabId) {
                const tab = tabs.find(t => t.id === currentTabId);
                if (tab && isHost) {
                    renderListGroups(tab.listGroups || []);
                }
            }
        });

        function saveTabs() {
            if (tabs.length === 0) {
                // „Çø„Éñ„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØFirebase„Åã„ÇâÂâäÈô§
                database.ref('tabs').remove();
            } else {
                const tabsObj = {};
                tabs.forEach(tab => {
                    tabsObj[tab.id] = tab;
                });
                database.ref('tabs').set(tabsObj);
            }
        }

        function showLoginPage() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function cancelLogin() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('hostIdInput').value = '';
        }

        function login() {
            const hostId = document.getElementById('hostIdInput').value.trim();
            
            if (hostId === 'yakumo') {
                isHost = true;
                document.getElementById('hostHomeControls').classList.remove('hidden');
                showNotification('„Éõ„Çπ„Éà„É¢„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºÅ');
                cancelLogin();
            } else {
                alert('ID„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        }

        function renderTabs() {
            const grid = document.getElementById('tabsGrid');
            grid.innerHTML = '';
            
            if (tabs.length === 0 && !isHost) {
                grid.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">„Çø„Éñ„Åå„Åæ„Å†‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }
            
            tabs.forEach(tab => {
                const button = document.createElement('button');
                button.className = 'tab-button';
                button.textContent = tab.title;
                button.onclick = () => openTab(tab.id);
                grid.appendChild(button);
            });
        }

        function openTab(tabId) {
            currentTabId = tabId;
            const tab = tabs.find(t => t.id === tabId);
            
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('tabPage').classList.remove('hidden');
            
            // „Çø„Éñ„ÅÆÁ®ÆÈ°û„Å´„Çà„Å£„Å¶Ë°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            if (tab.type === 'list') {
                document.getElementById('diceBarContainer').classList.add('hidden');
                document.getElementById('tabContentText').classList.remove('hidden');
                document.getElementById('imageSection').classList.add('hidden');
            } else if (tab.type === 'image') {
                document.getElementById('diceBarContainer').classList.add('hidden');
                document.getElementById('tabContentText').classList.add('hidden');
                document.getElementById('imageSection').classList.remove('hidden');
                loadImages();
                startImageTimer();
            } else {
                document.getElementById('diceBarContainer').classList.remove('hidden');
                document.getElementById('tabContentText').classList.remove('hidden');
                document.getElementById('imageSection').classList.add('hidden');
            }
            
            document.getElementById('tabContentText').textContent = tab.content || '„Åì„ÅÆ„Çø„Éñ„Å´„ÅØÂÜÖÂÆπ„Åå„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
            
            if (isHost) {
                document.getElementById('hostTabControls').classList.remove('hidden');
                loadTabSettings(tab);
                loadLogs(tab.id);
            }

            if (tab.type !== 'image') {
                rollAllDice();
            }
        }

        function loadTabSettings(tab) {
            document.getElementById('editTabTitle').value = tab.title;
            document.getElementById('editTabContent').value = tab.content;
            document.getElementById('editTabType').value = tab.type || 'dice';
            
            if (tab.type === 'list') {
                renderListGroups(tab.listGroups || []);
            } else {
                document.getElementById('editDiceCount').value = tab.diceCount;
                document.getElementById('editDiceMin').value = tab.diceMin;
                document.getElementById('editDiceMax').value = tab.diceMax;
                document.getElementById('editDiceLabels').value = tab.labels.join(',');
            }
            
            toggleTabTypeSettings();
        }

        function toggleTabTypeSettings() {
            const type = document.getElementById('editTabType').value;
            if (type === 'dice') {
                document.getElementById('diceSettings').classList.remove('hidden');
                document.getElementById('listSettings').classList.add('hidden');
                document.getElementById('imageSettings').classList.add('hidden');
            } else if (type === 'list') {
                document.getElementById('diceSettings').classList.add('hidden');
                document.getElementById('listSettings').classList.remove('hidden');
                document.getElementById('imageSettings').classList.add('hidden');
            } else {
                document.getElementById('diceSettings').classList.add('hidden');
                document.getElementById('listSettings').classList.add('hidden');
                document.getElementById('imageSettings').classList.remove('hidden');
            }
        }

        function renderListGroups(listGroups) {
            const container = document.getElementById('listGroupsContainer');
            container.innerHTML = '';
            
            listGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'list-group';
                groupDiv.innerHTML = `
                    <div class="list-group-header">
                        <input type="text" value="${group.name}" 
                               onchange="updateListGroupName(${groupIndex}, this.value)"
                               style="flex: 1; margin-right: 10px; padding: 5px; border: 2px solid #ffc107; border-radius: 5px;">
                        <button onclick="deleteListGroup(${groupIndex})" 
                                style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            ÂâäÈô§
                        </button>
                    </div>
                    <label style="font-size: 0.9em; color: #856404;">ÊäΩÈÅ∏„Åô„ÇãÊï∞:</label>
                    <input type="number" value="${group.count}" min="1" max="10"
                           onchange="updateListGroupCount(${groupIndex}, this.value)"
                           style="width: 100%; padding: 5px; border: 2px solid #ffc107; border-radius: 5px; margin-bottom: 10px;">
                    <input type="text" placeholder="È†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶Enter" 
                           onkeypress="handleListItemAdd(event, ${groupIndex})"
                           style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 5px; margin-bottom: 5px;">
                    <div class="list-items" id="listItems${groupIndex}"></div>
                `;
                container.appendChild(groupDiv);
                
                // „Ç¢„Ç§„ÉÜ„É†„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
                renderListItems(groupIndex, group.items || []);
            });
        }

        function renderListItems(groupIndex, items) {
            const container = document.getElementById('listItems' + groupIndex);
            if (!container) return;
            
            container.innerHTML = '';
            items.forEach((item, itemIndex) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span>${item}</span>
                    <button onclick="removeListItem(${groupIndex}, ${itemIndex})">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        function addListGroup() {
            const tab = tabs.find(t => t.id === currentTabId);
            if (!tab.listGroups) tab.listGroups = [];
            
            tab.listGroups.push({
                name: '„É™„Çπ„ÉàÊäΩÈÅ∏' + (tab.listGroups.length + 1),
                count: 1,
                items: []
            });
            
            renderListGroups(tab.listGroups);
        }

        function deleteListGroup(groupIndex) {
            const tab = tabs.find(t => t.id === currentTabId);
            tab.listGroups.splice(groupIndex, 1);
            renderListGroups(tab.listGroups);
        }

        function updateListGroupName(groupIndex, name) {
            const tab = tabs.find(t => t.id === currentTabId);
            tab.listGroups[groupIndex].name = name;
        }

        function updateListGroupCount(groupIndex, count) {
            const tab = tabs.find(t => t.id === currentTabId);
            tab.listGroups[groupIndex].count = parseInt(count);
        }

        function handleListItemAdd(event, groupIndex) {
            if (event.key === 'Enter') {
                const value = event.target.value.trim();
                if (value) {
                    const tab = tabs.find(t => t.id === currentTabId);
                    if (!tab.listGroups[groupIndex].items) {
                        tab.listGroups[groupIndex].items = [];
                    }
                    tab.listGroups[groupIndex].items.push(value);
                    renderListItems(groupIndex, tab.listGroups[groupIndex].items);
                    event.target.value = '';
                }
            }
        }

        function removeListItem(groupIndex, itemIndex) {
            const tab = tabs.find(t => t.id === currentTabId);
            tab.listGroups[groupIndex].items.splice(itemIndex, 1);
            renderListItems(groupIndex, tab.listGroups[groupIndex].items);
        }

        function goHome() {
            document.getElementById('tabPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            currentTabId = null;
            if (imageTimerInterval) {
                clearInterval(imageTimerInterval);
                imageTimerInterval = null;
            }
        }

        function rollAllDice() {
            const now = Date.now();
            if (now - lastRollTime < ROLL_COOLDOWN) {
                const remaining = Math.ceil((ROLL_COOLDOWN - (now - lastRollTime)) / 1000);
                showNotification(`„ÅÇ„Å®${remaining}ÁßíÂæÖ„Å£„Å¶„Åè„Å†„Åï„ÅÑ`);
                return;
            }
            
            lastRollTime = now;
            const rollButton = document.getElementById('rollButton');
            if (rollButton) rollButton.disabled = true;
            
            const tab = tabs.find(t => t.id === currentTabId);
            let results = [];
            let displayText = '';
            
            if (tab.type === 'list') {
                // „É™„Çπ„ÉàÊäΩÈÅ∏ - „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç
                const contentBox = document.getElementById('tabContentText');
                
                // 2ÁßíÈñì„É©„É≥„ÉÄ„É†„Å´ÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
                const animationDuration = 2000;
                const animationInterval = 100;
                let animationElapsed = 0;
                
                const animationTimer = setInterval(() => {
                    const tempResults = [];
                    tab.listGroups.forEach(group => {
                        const count = Math.min(group.count || 1, group.items.length);
                        const shuffled = [...group.items].sort(() => Math.random() - 0.5);
                        const selected = shuffled.slice(0, count);
                        tempResults.push(`„Äê${group.name}„Äë\n${selected.join(', ')}`);
                    });
                    contentBox.textContent = tempResults.join('\n\n');
                    
                    animationElapsed += animationInterval;
                    if (animationElapsed >= animationDuration) {
                        clearInterval(animationTimer);
                        
                        // ÊúÄÁµÇÁµêÊûú„ÇíË°®Á§∫
                        const finalResults = [];
                        tab.listGroups.forEach(group => {
                            const count = Math.min(group.count || 1, group.items.length);
                            const shuffled = [...group.items].sort(() => Math.random() - 0.5);
                            const selected = shuffled.slice(0, count);
                            finalResults.push(`„Äê${group.name}„Äë\n${selected.join(', ')}`);
                            results.push(...selected);
                        });
                        displayText = finalResults.join('\n\n');
                        contentBox.textContent = displayText;
                        logRoll(results, displayText);
                    }
                }, animationInterval);
                
            } else {
                // „Çµ„Ç§„Ç≥„É≠ - „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç
                const labelsDiv = document.getElementById('diceLabels');
                
                // 2ÁßíÈñì„É©„É≥„ÉÄ„É†„Å´Êï∞Â≠ó„ÇíË°®Á§∫
                const animationDuration = 2000;
                const animationInterval = 100;
                let animationElapsed = 0;
                
                labelsDiv.classList.add('rolling-animation');
                
                const animationTimer = setInterval(() => {
                    const tempResults = [];
                    for (let i = 0; i < tab.diceCount; i++) {
                        const result = Math.floor(Math.random() * (tab.diceMax - tab.diceMin + 1)) + tab.diceMin;
                        tempResults.push(result);
                    }
                    
                    const labelParts = [];
                    for (let i = 0; i < tempResults.length; i++) {
                        const label = tab.labels[i] || String.fromCharCode(119 + i);
                        labelParts.push(`${label}:${tempResults[i]}`);
                    }
                    labelsDiv.textContent = labelParts.join(' ');
                    
                    animationElapsed += animationInterval;
                    if (animationElapsed >= animationDuration) {
                        clearInterval(animationTimer);
                        
                        // ÊúÄÁµÇÁµêÊûú„ÇíË°®Á§∫
                        results = [];
                        for (let i = 0; i < tab.diceCount; i++) {
                            const result = Math.floor(Math.random() * (tab.diceMax - tab.diceMin + 1)) + tab.diceMin;
                            results.push(result);
                        }
                        
                        const labelParts = [];
                        for (let i = 0; i < results.length; i++) {
                            const label = tab.labels[i] || String.fromCharCode(119 + i);
                            labelParts.push(`${label}:${results[i]}`);
                        }
                        displayText = labelParts.join(' ');
                        labelsDiv.textContent = displayText;
                        labelsDiv.classList.remove('rolling-animation');
                        logRoll(results, displayText);
                    }
                }, animationInterval);
            }
            
            setTimeout(() => {
                if (rollButton) rollButton.disabled = false;
            }, ROLL_COOLDOWN);
        }

        function logRoll(results, displayText) {
            const timestamp = new Date().toLocaleString('ja-JP');
            const ip = 'ip-address'
            
            const logEntry = {
                timestamp,
                ip,
                results: results,
                display: displayText,
                tabId: currentTabId
            };
            
            database.ref('logs/' + currentTabId).push(logEntry);
        }

        function loadLogs(tabId) {
            database.ref('logs/' + tabId).limitToLast(100).on('value', (snapshot) => {
                const logDiv = document.getElementById('diceLog');
                logDiv.innerHTML = '';
                
                const logs = [];
                snapshot.forEach((child) => {
                    logs.push(child.val());
                });
                
                if (logs.length === 0) {
                    logDiv.innerHTML = '<p style="color: #999;">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                    return;
                }
                
                logs.reverse().forEach(log => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    const resultText = log.display || (Array.isArray(log.results) ? log.results.join(', ') : log.results);
                    entry.innerHTML = `
                        <strong>${log.timestamp}</strong><br>
                        IP: ${log.ip}<br>
                        ÁµêÊûú: ${resultText}
                    `;
                    logDiv.appendChild(entry);
                });
            });
        }

        function applyTabSettings() {
            const tab = tabs.find(t => t.id === currentTabId);
            
            tab.title = document.getElementById('editTabTitle').value;
            tab.content = document.getElementById('editTabContent').value;
            tab.type = document.getElementById('editTabType').value;
            
            if (tab.type === 'dice') {
                tab.diceCount = parseInt(document.getElementById('editDiceCount').value);
                tab.diceMin = parseInt(document.getElementById('editDiceMin').value);
                tab.diceMax = parseInt(document.getElementById('editDiceMax').value);
                
                const labelsInput = document.getElementById('editDiceLabels').value;
                tab.labels = labelsInput.split(',').map(l => l.trim()).filter(l => l);
            }
            
            document.getElementById('tabContentText').textContent = tab.content || '„Åì„ÅÆ„Çø„Éñ„Å´„ÅØÂÜÖÂÆπ„Åå„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
            
            // „Çø„Éñ„ÅÆÁ®ÆÈ°û„Å´„Çà„Å£„Å¶Ë°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
            if (tab.type === 'list') {
                document.getElementById('diceBarContainer').classList.add('hidden');
            } else {
                document.getElementById('diceBarContainer').classList.remove('hidden');
            }
            
            saveTabs();
            rollAllDice();
            showNotification('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function addNewTab() {
            const title = prompt('Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ:');
            if (!title) return;
            
            const typeChoice = prompt('„Çø„Éñ„ÅÆÁ®ÆÈ°û„ÇíÈÅ∏Êäû:\n1: „Çµ„Ç§„Ç≥„É≠\n2: „É™„Çπ„ÉàÊäΩÈÅ∏\n3: ÁîªÂÉèÊäïÁ®ø', '1');
            let type = 'dice';
            if (typeChoice === '2') type = 'list';
            if (typeChoice === '3') type = 'image';
            
            const newId = tabs.length > 0 ? Math.max(...tabs.map(t => t.id)) + 1 : 1;
            tabs.push({
                id: newId,
                title: title,
                content: '',
                type: type,
                diceCount: 2,
                diceMin: 1,
                diceMax: 6,
                labels: ['w', 'x'],
                listGroups: []
            });
            
            saveTabs();
            showNotification('„Çø„Éñ„ÇíËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function deleteTab() {
            if (!confirm('„Åì„ÅÆ„Çø„Éñ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„ÇìÔºâ')) return;
            
            const deletedId = currentTabId;
            tabs = tabs.filter(t => t.id !== deletedId);
            
            // „É≠„Ç∞„ÇÇÂâäÈô§
            database.ref('logs/' + deletedId).remove();
            
            // „Çø„Éñ„Çí‰øùÂ≠ò
            saveTabs();
            
            // „Éõ„Éº„É†„Å´Êàª„Çã
            goHome();
            showNotification('„Çø„Éñ„ÇíÂâäÈô§„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'save-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        </script>

        <script>
        // Ëá™ÂàÜ„ÅÆIP„Ç¢„Éâ„É¨„Çπ„ÇíÂèñÂæó„Åô„Çã„Åü„ÇÅ„ÅÆAPI
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ip-address').textContent = data.ip;
            })
    </script>

</body>
</html>
