<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÅãÂëΩ„ÅÆ„ÉÄ„Ç§„Çπ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .header h1:hover {
            opacity: 0.8;
        }

        .login-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        /* „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏ */
        .login-page {
            text-align: center;
            padding: 60px 20px;
        }

        .login-page h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-page input {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #667eea;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .login-page button {
            padding: 15px 40px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 0 10px;
            transition: transform 0.2s;
        }

        .login-page button:hover {
            transform: scale(1.05);
        }

        .login-page .cancel-btn {
            background: #6c757d;
        }

        /* „Éõ„Éº„É†ÁîªÈù¢ */
        .tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .tab-button {
            padding: 50px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tab-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        /* Âõ∫ÂÆö„Çµ„Ç§„Ç≥„É≠„Éê„Éº */
        .dice-bar {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 100;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .dice-labels-bar {
            color: white;
            font-size: 1.5em;
            font-weight: bold;
        }

        .roll-button-bar {
            padding: 8px 12px;
            font-size: 1.3em;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .roll-button-bar:hover {
            transform: scale(1.1);
        }

        /* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .tab-content-box {
            margin: 30px auto;
            padding: 40px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1em;
            line-height: 1.8;
            color: #333;
            min-height: 200px;
            white-space: pre-wrap;
            max-width: 100%;
        }

        /* „Éõ„Çπ„Éà„Ç≥„É≥„Éà„É≠„Éº„É´ */
        .host-controls {
            margin: 30px;
            padding: 25px;
            background: #fff3cd;
            border-radius: 10px;
            border: 2px solid #ffc107;
        }

        .host-controls h3 {
            color: #856404;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .host-controls label {
            display: block;
            margin: 15px 0 5px 0;
            color: #856404;
            font-weight: bold;
        }

        .host-controls input, .host-controls textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .host-controls textarea {
            min-height: 150px;
            resize: vertical;
        }

        .host-controls button {
            padding: 12px 30px;
            background: #ffc107;
            color: #856404;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            margin: 10px 10px 0 0;
        }

        .host-controls button:hover {
            background: #e0a800;
        }

        .host-controls .danger-btn {
            background: #dc3545;
            color: white;
        }

        .host-controls .danger-btn:hover {
            background: #c82333;
        }

        .host-controls .save-btn {
            background: #28a745;
            color: white;
        }

        .host-controls .save-btn:hover {
            background: #218838;
        }

        .dice-log {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }

        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 onclick="goHome()">ÈÅãÂëΩ„ÅÆ„ÉÄ„Ç§„Çπ</h1>
            <button class="login-btn" onclick="showLoginPage()">üîë</button>
        </div>

        <div class="content">
            <!-- „É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏ -->
            <div id="loginPage" class="login-page hidden">
                <h2>„Éõ„Çπ„Éà„É≠„Ç∞„Ç§„É≥</h2>
                <input type="password" id="hostIdInput" placeholder="„Éõ„Çπ„ÉàID">
                <br>
                <button onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
                <button class="cancel-btn" onclick="cancelLogin()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>

            <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
            <div id="homePage">
                <div class="tabs-grid" id="tabsGrid">
                    <!-- „Çø„Éñ„Éú„Çø„É≥„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>

                <!-- „Éõ„Çπ„ÉàË®≠ÂÆö - „Éõ„Éº„É† -->
                <div id="hostHomeControls" class="host-controls hidden">
                    <h3>üîß „Éõ„Éº„É†Ë®≠ÂÆö</h3>
                    <button onclick="addNewTab()">‚ûï Êñ∞„Åó„ÅÑ„Çø„Éñ„ÇíËøΩÂä†</button>
                    <button class="save-btn" onclick="saveAllSettings()">üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                </div>
            </div>

            <!-- „Çø„Éñ„Éö„Éº„Ç∏ -->
            <div id="tabPage" class="hidden">
                <div class="dice-bar">
                    <div class="dice-labels-bar" id="diceLabels"></div>
                    <button class="roll-button-bar" onclick="rollAllDice()">üé≤</button>
                </div>

                <div class="tab-content-box" id="tabContentText"></div>

                <!-- „Éõ„Çπ„ÉàË®≠ÂÆö - „Çø„Éñ -->
                <div id="hostTabControls" class="host-controls hidden">
                    <h3>üîß „Çø„ÉñË®≠ÂÆö</h3>
                    
                    <label>„Çø„Éñ„Çø„Ç§„Éà„É´:</label>
                    <input type="text" id="editTabTitle">
                    
                    <label>„Çø„ÉñÂÜÖÂÆπ:</label>
                    <textarea id="editTabContent" placeholder="„Çø„Éñ„ÅÆË™¨Êòé„ÇÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ..."></textarea>
                    
                    <label>„Çµ„Ç§„Ç≥„É≠„ÅÆÊï∞:</label>
                    <input type="number" id="editDiceCount" value="2" min="1" max="10">
                    
                    <label>„Çµ„Ç§„Ç≥„É≠„ÅÆÁØÑÂõ≤ÔºàÊúÄÂ∞èÔºâ:</label>
                    <input type="number" id="editDiceMin" value="1" min="0">
                    
                    <label>„Çµ„Ç§„Ç≥„É≠„ÅÆÁØÑÂõ≤ÔºàÊúÄÂ§ßÔºâ:</label>
                    <input type="number" id="editDiceMax" value="6" min="1">
                    
                    <label>„Çµ„Ç§„Ç≥„É≠„ÅÆ„É©„Éô„É´Ôºà„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÄÅ‰æã: w,x,y,zÔºâ:</label>
                    <input type="text" id="editDiceLabels" value="w,x">
                    
                    <button onclick="applyTabSettings()">Ë®≠ÂÆö„ÇíÈÅ©Áî®</button>
                    <button class="save-btn" onclick="saveAllSettings()">üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                    <button class="danger-btn" onclick="deleteTab()">üóëÔ∏è „Åì„ÅÆ„Çø„Éñ„ÇíÂâäÈô§</button>
                    
                    <h3 style="margin-top: 30px;">üìä „Çµ„Ç§„Ç≥„É≠„ÅÆË®òÈå≤</h3>
                    <div class="dice-log" id="diceLog"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isHost = false;
        let currentTabId = null;
        
        // Ê∞∏Á∂öÂåñ„Ç≠„Éº
        const STORAGE_KEY = 'diceTabsSharedData';
        
        // ÂÖ±Êúâ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„ÅøÔºàwindow.storage„Çí‰ΩøÁî®Ôºâ
        let tabs = [];
        
        async function loadSharedData() {
            try {
                const result = await window.storage.get(STORAGE_KEY, true);
                if (result && result.value) {
                    tabs = JSON.parse(result.value);
                } else {
                    // ÂàùÊúü„Éá„Éº„Çø
                    tabs = [
                        { id: 1, title: 'ÈÅãË©¶„Åó„Çµ„Ç§„Ç≥„É≠', content: '', diceCount: 2, diceMin: 1, diceMax: 6, labels: ['w', 'x'], logs: [] },
                        { id: 2, title: 'Ê±∫Êñ≠„Çµ„Ç§„Ç≥„É≠', content: '', diceCount: 2, diceMin: 1, diceMax: 6, labels: ['w', 'x'], logs: [] },
                        { id: 3, title: '„ÉÅ„É£„É¨„É≥„Ç∏„Çµ„Ç§„Ç≥„É≠', content: '', diceCount: 2, diceMin: 1, diceMax: 6, labels: ['w', 'x'], logs: [] }
                    ];
                    await saveSharedData();
                }
            } catch (error) {
                console.log('ÂàùÂõûË™≠„ÅøËæº„Åø„ÄÅ„Éá„Éï„Ç©„É´„Éà„Éá„Éº„Çø„Çí‰ΩøÁî®');
                tabs = [
                    { id: 1, title: 'ÈÅãË©¶„Åó„Çµ„Ç§„Ç≥„É≠', content: '', diceCount: 2, diceMin: 1, diceMax: 6, labels: ['w', 'x'], logs: [] },
                    { id: 2, title: 'Ê±∫Êñ≠„Çµ„Ç§„Ç≥„É≠', content: '', diceCount: 2, diceMin: 1, diceMax: 6, labels: ['w', 'x'], logs: [] },
                    { id: 3, title: '„ÉÅ„É£„É¨„É≥„Ç∏„Çµ„Ç§„Ç≥„É≠', content: '', diceCount: 2, diceMin: 1, diceMax: 6, labels: ['w', 'x'], logs: [] }
                ];
            }
            renderTabs();
        }
        
        async function saveSharedData() {
            try {
                await window.storage.set(STORAGE_KEY, JSON.stringify(tabs), true);
            } catch (error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
            }
        }
        
        let nextTabId = 1;

        // ÂàùÊúüÂåñ
        loadSharedData();

        function showLoginPage() {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        }

        function cancelLogin() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('hostIdInput').value = '';
        }

        function login() {
            const hostId = document.getElementById('hostIdInput').value.trim();
            
            if (hostId === 'yakumo') {
                isHost = true;
                document.getElementById('hostHomeControls').classList.remove('hidden');
                showNotification('„Éõ„Çπ„Éà„É¢„Éº„Éâ„Åß„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„ÅüÔºÅ');
                cancelLogin();
            } else {
                alert('ID„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        }

        function renderTabs() {
            const grid = document.getElementById('tabsGrid');
            grid.innerHTML = '';
            
            tabs.forEach(tab => {
                const button = document.createElement('button');
                button.className = 'tab-button';
                button.textContent = tab.title;
                button.onclick = () => openTab(tab.id);
                grid.appendChild(button);
            });
            
            nextTabId = Math.max(...tabs.map(t => t.id), 0) + 1;
        }

        async function openTab(tabId) {
            // ÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
            await loadSharedData();
            
            currentTabId = tabId;
            const tab = tabs.find(t => t.id === tabId);
            
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('tabPage').classList.remove('hidden');
            document.getElementById('tabContentText').textContent = tab.content || '„Åì„ÅÆ„Çø„Éñ„Å´„ÅØÂÜÖÂÆπ„Åå„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
            
            if (isHost) {
                document.getElementById('hostTabControls').classList.remove('hidden');
                document.getElementById('editTabTitle').value = tab.title;
                document.getElementById('editTabContent').value = tab.content;
                document.getElementById('editDiceCount').value = tab.diceCount;
                document.getElementById('editDiceMin').value = tab.diceMin;
                document.getElementById('editDiceMax').value = tab.diceMax;
                document.getElementById('editDiceLabels').value = tab.labels.join(',');
                renderDiceLog(tab);
            }
            
            rollAllDice();
        }

        function goHome() {
            document.getElementById('tabPage').classList.add('hidden');
            document.getElementById('homePage').classList.remove('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            currentTabId = null;
        }

        async function rollAllDice() {
            const tab = tabs.find(t => t.id === currentTabId);
            const results = [];
            
            for (let i = 0; i < tab.diceCount; i++) {
                const result = Math.floor(Math.random() * (tab.diceMax - tab.diceMin + 1)) + tab.diceMin;
                results.push(result);
            }
            
            updateDiceLabels(results);
            await logDiceRoll(results);
        }

        function updateDiceLabels(results) {
            const tab = tabs.find(t => t.id === currentTabId);
            const labelsDiv = document.getElementById('diceLabels');
            const labelParts = [];
            
            for (let i = 0; i < results.length; i++) {
                const label = tab.labels[i] || String.fromCharCode(119 + i); // w, x, y, z...
                labelParts.push(`${label}:${results[i]}`);
            }
            
            labelsDiv.textContent = labelParts.join(' ');
        }

        async function logDiceRoll(results) {
            const tab = tabs.find(t => t.id === currentTabId);
            const timestamp = new Date().toLocaleString('ja-JP');
            const ip = '192.168.1.' + Math.floor(Math.random() * 255); // Ê®°Êì¨IP
            
            const logEntry = {
                timestamp,
                ip,
                results: [...results]
            };
            
            tab.logs.unshift(logEntry);
            if (tab.logs.length > 100) tab.logs.pop(); // ÊúÄÂ§ß100‰ª∂
            
            if (isHost) {
                renderDiceLog(tab);
            }
            
            await saveSharedData();
        }

        function renderDiceLog(tab) {
            const logDiv = document.getElementById('diceLog');
            logDiv.innerHTML = '';
            
            if (tab.logs.length === 0) {
                logDiv.innerHTML = '<p style="color: #999;">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }
            
            tab.logs.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const resultLabels = log.results.map((r, i) => {
                    const label = tab.labels[i] || String.fromCharCode(119 + i);
                    return `${label}:${r}`;
                }).join(' ');
                entry.innerHTML = `
                    <strong>${log.timestamp}</strong><br>
                    IP: ${log.ip}<br>
                    ÁµêÊûú: ${resultLabels}
                `;
                logDiv.appendChild(entry);
            });
        }

        async function applyTabSettings() {
            const tab = tabs.find(t => t.id === currentTabId);
            
            tab.title = document.getElementById('editTabTitle').value;
            tab.content = document.getElementById('editTabContent').value;
            tab.diceCount = parseInt(document.getElementById('editDiceCount').value);
            tab.diceMin = parseInt(document.getElementById('editDiceMin').value);
            tab.diceMax = parseInt(document.getElementById('editDiceMax').value);
            
            const labelsInput = document.getElementById('editDiceLabels').value;
            tab.labels = labelsInput.split(',').map(l => l.trim()).filter(l => l);
            
            document.getElementById('tabContentText').textContent = tab.content || '„Åì„ÅÆ„Çø„Éñ„Å´„ÅØÂÜÖÂÆπ„Åå„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
            
            rollAllDice();
            renderTabs();
            await saveSharedData();
        }

        async function addNewTab() {
            const title = prompt('Êñ∞„Åó„ÅÑ„Çø„Éñ„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ:');
            if (!title) return;
            
            tabs.push({
                id: nextTabId++,
                title: title,
                content: '',
                diceCount: 2,
                diceMin: 1,
                diceMax: 6,
                labels: ['w', 'x'],
                logs: []
            });
            
            renderTabs();
            await saveSharedData();
        }

        async function deleteTab() {
            if (!confirm('„Åì„ÅÆ„Çø„Éñ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            
            tabs = tabs.filter(t => t.id !== currentTabId);
            renderTabs();
            goHome();
            await saveSharedData();
        }

        async function saveAllSettings() {
            await saveSharedData();
            showNotification('üíæ Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'save-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
